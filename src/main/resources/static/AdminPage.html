<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>BarangayConnect - Admin Dashboard</title>
  <link rel="stylesheet" href="admin-style.css" />
  <script src="https://kit.fontawesome.com/a2e0f1f0c1.js" crossorigin="anonymous"></script>
  <script src="../activity-log.js"></script>
  <style>
    /* Global scrollbar hiding for all elements */
    * {
      scrollbar-width: none !important; /* Firefox */
      -ms-overflow-style: none !important; /* Internet Explorer 10+ */
    }
    
    *::-webkit-scrollbar {
      display: none !important; /* WebKit */
    }
    
    /* Ensure iframes don't show scrollbars */
    iframe {
      scrollbar-width: none !important;
      -ms-overflow-style: none !important;
    }
    
    iframe::-webkit-scrollbar {
      display: none !important;
    }
  </style>
</head>
<body class="admin-body">

  <!-- Admin Header -->
  <header class="admin-header">
    <div class="header-left">
      <h1>
        <span class="brand-logo" aria-hidden="true"><img src="BC_House.png" alt="BarangayConnect logo" /></span>
        BarangayConnect
      </h1>
    </div>
    <div class="header-right">
      <div class="settings-dropdown">
        <button class="header-btn" title="Settings" onclick="toggleSettings()"><i class="fas fa-cog"></i></button>
        <div class="settings-menu" id="settingsMenu">
          <a href="#" class="settings-item" onclick="openActivityLog()">
            <i class="fas fa-history"></i>
            <span>Activity Log</span>
          </a>
          <a href="#" class="settings-item" onclick="logout()">
            <i class="fas fa-sign-out-alt"></i>
            <span>Log out</span>
          </a>
        </div>
      </div>
    </div>
  </header>

  <!-- Admin Container -->
  <div class="admin-container">
    <!-- Modern Sidebar -->
    <aside class="modern-sidebar" aria-label="Primary">
      <div class="sidebar-toggle" onclick="toggleSidebar()">
        <div class="hamburger">
          <span></span>
          <span></span>
          <span></span>
        </div>
      </div>
      
      <div class="sidebar-content">
      <div class="sidebar-header">
          <div class="user-info">
            <div class="user-details">
          <h3>Hello, Secretary!</h3>
              <p>Administrator</p>
            </div>
          </div>
        </div>
        
        <nav class="sidebar-nav">
          <ul class="nav-list">
            <li class="nav-item active">
              <a href="#" class="nav-link" data-section="dashboard">
                <i class="fas fa-home"></i>
                <span>Home</span>
              </a>
            </li>
            <li class="nav-item">
              <a href="#" class="nav-link" data-section="reports">
                <i class="fas fa-file-invoice"></i>
                <span>Reports</span>
              </a>
            </li>
            <li class="nav-item">
              <a href="#" class="nav-link" data-section="requests">
                <i class="fas fa-file-alt"></i>
                <span>Requests</span>
              </a>
            </li>
            <li class="nav-item">
              <a href="#" class="nav-link" data-section="transparency">
                <i class="fas fa-balance-scale"></i>
                <span>Transparency</span>
              </a>
            </li>
            <li class="nav-item">
              <a href="#" class="nav-link" data-section="announcements">
                <i class="fas fa-bullhorn"></i>
                <span>Announcements</span>
              </a>
            </li>
            <li class="nav-item">
              <a href="#" class="nav-link" data-section="users">
                <i class="fas fa-users"></i>
                <span>User Management</span>
              </a>
            </li>
            <li class="nav-item">
              <a href="#" class="nav-link" data-section="emergency">
                <i class="fas fa-phone"></i>
                <span>Emergency</span>
              </a>
            </li>
            <li class="nav-item">
              <a href="#" class="nav-link" data-section="feedback">
                <i class="fas fa-star"></i>
                <span>Feedback</span>
              </a>
            </li>

          </ul>
        </nav>
        
      </div>
    </aside>

    <!-- Main Content Area -->
    <main class="admin-main">
      <div class="main-content">
        <!-- Content sections will be loaded dynamically -->
        <div id="dashboard-section" class="content-section active">
          <iframe src="A_Home-Dashboard.html" frameborder="0" width="100%" height="100%" style="border: none; height: 100vh; margin: 0; padding: 0; display: block; overflow: hidden;"></iframe>
        </div>

        <div id="reports-section" class="content-section">
          <iframe src="A_Reports.html" frameborder="0" width="100%" height="100%" style="border: none; height: 100vh; margin: 0; padding: 0; display: block; overflow: hidden;"></iframe>
        </div>

        <div id="requests-section" class="content-section">
          <iframe src="A_Request-Management.html" frameborder="0" width="100%" height="100%" style="border: none; height: 100vh; margin: 0; padding: 0; display: block; overflow: hidden;"></iframe>
        </div>

        <div id="transparency-section" class="content-section">
          <iframe src="A_Transparency.html" frameborder="0" width="100%" height="100%" style="border: none; height: 100vh; margin: 0; padding: 0; display: block; overflow: hidden;"></iframe>
        </div>

        <div id="announcements-section" class="content-section">
          <iframe src="A_Announcements.html" frameborder="0" width="100%" height="100%" style="border: none; height: 100vh; margin: 0; padding: 0; display: block; overflow: hidden;"></iframe>
        </div>

        <div id="users-section" class="content-section">
          <iframe src="A_User-Management.html" frameborder="0" width="100%" height="100%" style="border: none; height: 100vh; margin: 0; padding: 0; display: block; overflow: hidden;"></iframe>
        </div>

        <div id="emergency-section" class="content-section">
          <iframe src="A_Emergency.html" frameborder="0" width="100%" height="100%" style="border: none; height: 100vh; margin: 0; padding: 0; display: block; overflow: hidden;"></iframe>
        </div>
        <div id="feedback-section" class="content-section">
          <iframe src="A_Feedback.html" frameborder="0" width="100%" height="100%" style="border: none; height: 100vh; margin: 0; padding: 0; display: block; overflow: hidden;"></iframe>
        </div>

      </div>
    </main>
  </div>

  <!-- Activity Log Modal -->
  <div id="activityLogModal" class="modal">
    <div class="modal-content activity-log-modal">
      <span class="close" data-close="activityLogModal">&times;</span>
      <h2><i class="fas fa-history"></i> Activity Log</h2>
      
      <div class="activity-log-filters">
        <select id="activityLogFilter" onchange="filterActivityLog()">
          <option value="ALL">All Activities</option>
          <option value="LOGIN">Login</option>
          <option value="LOGOUT">Logout</option>
          <option value="FAILED_LOGIN">Failed Login</option>
          <option value="PASSWORD_CHANGE">Password Change</option>
          <option value="PROFILE_UPDATE">Profile Update</option>
        </select>
        <div class="activity-log-search">
          <input type="text" id="activityLogSearch" placeholder="Search activities..." onkeyup="searchActivityLog()" />
          <button type="button" onclick="searchActivityLog()" class="search-btn" title="Search">
            <i class="fas fa-search"></i>
          </button>
        </div>
      </div>
      
      <div class="activity-log-container" id="activityLogContainer">
        <!-- Activity log entries will be inserted here -->
      </div>
      
      <div class="activity-log-empty" id="activityLogEmpty" style="display: none;">
        <i class="fas fa-inbox"></i>
        <p>No activity logs found</p>
      </div>
    </div>
  </div>

  <script>
    // Navigation functionality
    document.querySelectorAll('.nav-link').forEach(link => {
      link.addEventListener('click', function(e) {
        e.preventDefault();
        
        // Remove active class from all nav items
        document.querySelectorAll('.nav-item').forEach(item => {
          item.classList.remove('active');
        });
        
        // Add active class to clicked item
        this.parentElement.classList.add('active');
        
        // Hide all content sections
        document.querySelectorAll('.content-section').forEach(section => {
          section.classList.remove('active');
        });
        
        // Show selected section
        const sectionId = this.getAttribute('data-section') + '-section';
        const targetSection = document.getElementById(sectionId);
        if (targetSection) {
          targetSection.classList.add('active');
        }
      });
    });

    // Settings dropdown functionality
    function toggleSettings() {
      const settingsMenu = document.getElementById('settingsMenu');
      settingsMenu.classList.toggle('show');
    }

    // Close settings menu when clicking outside
    document.addEventListener('click', function(event) {
      const settingsDropdown = document.querySelector('.settings-dropdown');
      const settingsMenu = document.getElementById('settingsMenu');
      
      if (!settingsDropdown.contains(event.target)) {
        settingsMenu.classList.remove('show');
      }
    });

    // Activity Log functionality
    function openActivityLog() {
      document.getElementById('settingsMenu').classList.remove('show');
      const modal = document.getElementById('activityLogModal');
      if (modal) {
        modal.style.display = 'block';
        // Clear search input when opening
        const searchInput = document.getElementById('activityLogSearch');
        if (searchInput) searchInput.value = '';
        // Small delay to ensure modal is visible before loading
        setTimeout(() => {
          loadActivityLog();
        }, 100);
      } else {
        console.error('Activity log modal not found');
      }
    }

    function closeActivityLog() {
      document.getElementById('activityLogModal').style.display = 'none';
    }

    function loadActivityLog(filterType = 'ALL', searchTerm = '') {
      const container = document.getElementById('activityLogContainer');
      const emptyState = document.getElementById('activityLogEmpty');
      
      // Check if functions are available
      if (typeof getAllActivityLog === 'undefined' || typeof getActivityLogByType === 'undefined') {
        console.error('Activity log functions not loaded. Please ensure activity-log.js is loaded.');
        if (container) container.innerHTML = '<div style="padding: 2rem; text-align: center; color: #e74c3c;">Error: Activity log functions not available. Please refresh the page.</div>';
        if (emptyState) emptyState.style.display = 'none';
        return;
      }
      
      let activities;
      if (filterType === 'ALL') {
        activities = getAllActivityLog(100);
      } else {
        activities = getActivityLogByType(filterType, 100);
      }
      
      // Apply search filter if search term is provided
      if (searchTerm) {
        const searchLower = searchTerm.toLowerCase();
        activities = activities.filter(activity => {
          const userName = (activity.userName || '').toLowerCase();
          const userId = (activity.userId || '').toLowerCase();
          const activityType = (activity.activityType || '').toLowerCase();
          const userType = (activity.userType || '').toLowerCase();
          const typeInfo = getActivityTypeInfo(activity.activityType);
          const activityName = (typeInfo.name || '').toLowerCase();
          
          return userName.includes(searchLower) ||
                 userId.includes(searchLower) ||
                 activityType.includes(searchLower) ||
                 userType.includes(searchLower) ||
                 activityName.includes(searchLower);
        });
      }
      
      if (!container || !emptyState) {
        console.error('Activity log container elements not found');
        return;
      }
      
      if (activities.length === 0) {
        container.innerHTML = '';
        emptyState.style.display = 'block';
        return;
      }
      
      emptyState.style.display = 'none';
      
      // Check if helper functions are available
      if (typeof getActivityTypeInfo === 'undefined' || typeof formatActivityTimestamp === 'undefined' || typeof formatFullTimestamp === 'undefined') {
        console.error('Activity log helper functions not loaded.');
        container.innerHTML = '<div style="padding: 2rem; text-align: center; color: #e74c3c;">Error: Activity log helper functions not available. Please refresh the page.</div>';
        return;
      }
      
      container.innerHTML = activities.map(activity => {
        const typeInfo = getActivityTypeInfo(activity.activityType);
        const relativeTime = formatActivityTimestamp(activity.timestamp);
        const fullTimestamp = formatFullTimestamp(activity.timestamp);
        const userInfo = activity.userName || activity.userId || 'Unknown User';
        
        return `
          <div class="activity-log-entry">
            <div class="activity-icon" style="background-color: ${typeInfo.color}20; color: ${typeInfo.color};">
              <i class="fas ${typeInfo.icon}"></i>
            </div>
            <div class="activity-content">
              <div class="activity-header">
                <span class="activity-type" style="color: ${typeInfo.color};">${typeInfo.name}</span>
                <span class="activity-time" title="${fullTimestamp}">${fullTimestamp}</span>
              </div>
              <div class="activity-meta">
                <span class="activity-user">${userInfo} (${activity.userType})</span>
                <span class="activity-relative-time">${relativeTime}</span>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    function filterActivityLog() {
      const filterType = document.getElementById('activityLogFilter').value;
      const searchTerm = document.getElementById('activityLogSearch')?.value.trim() || '';
      loadActivityLog(filterType, searchTerm);
    }

    function searchActivityLog() {
      const filterType = document.getElementById('activityLogFilter').value;
      const searchTerm = document.getElementById('activityLogSearch')?.value.trim() || '';
      loadActivityLog(filterType, searchTerm);
    }

    // Logout functionality
    function logout() {
      if (confirm('Are you sure you want to logout?')) {
        // Get current admin user info before logout
        const admins = JSON.parse(localStorage.getItem('admins')) || [];
        const adminUsers = JSON.parse(localStorage.getItem('adminUsers')) || [];
        const currentAdmin = adminUsers.find(a => a.isLoggedIn) || admins.find(a => a.isLoggedIn);
        
        if (currentAdmin) {
          recordActivity(
            'LOGOUT',
            'ADMIN',
            currentAdmin.email || currentAdmin.username || 'admin',
            currentAdmin.name || currentAdmin.username || 'Administrator'
          );
        }
        
        alert('You have been logged out.');
        window.location.href = '../Front.html';
      }
      document.getElementById('settingsMenu').classList.remove('show');
    }

    // Modern sidebar toggle
    function toggleSidebar() {
      document.querySelector('.modern-sidebar').classList.toggle('collapsed');
    }
    
    // Add click event to hamburger menu icon
    document.addEventListener('DOMContentLoaded', function() {
      const hamburgerIcon = document.querySelector('.sidebar-toprow i.fa-bars');
      if (hamburgerIcon) {
        hamburgerIcon.addEventListener('click', toggleSidebar);
        hamburgerIcon.style.cursor = 'pointer';
      }
    });

    // Compute header height and update CSS variable so sidebar/content align with no gap
    function setHeaderOffset() {
      var header = document.querySelector('.admin-header');
      if (!header) return;
      var borderBottom = 3; // matches CSS border-bottom thickness
      var offset = header.offsetHeight + borderBottom;
      document.documentElement.style.setProperty('--header-offset', offset + 'px');
    }
    function setCurrentDate() {
      var dateElement = document.getElementById('current-date');
      if (dateElement) {
        var today = new Date();
        var options = { 
          weekday: 'long', 
          year: 'numeric', 
          month: 'long', 
          day: 'numeric' 
        };
        dateElement.textContent = today.toLocaleDateString('en-US', options);
      }
    }
    
    window.addEventListener('load', function() {
      setHeaderOffset();
      setCurrentDate();
      
      // Record admin login on page load
      const admins = JSON.parse(localStorage.getItem('admins')) || [];
      const adminUsers = JSON.parse(localStorage.getItem('adminUsers')) || [];
      const currentAdmin = adminUsers.find(a => a.isLoggedIn) || admins.find(a => a.isLoggedIn);
      
      if (currentAdmin && !sessionStorage.getItem('adminLoginRecorded')) {
        recordActivity(
          'LOGIN',
          'ADMIN',
          currentAdmin.email || currentAdmin.username || 'admin',
          currentAdmin.name || currentAdmin.username || 'Administrator'
        );
        sessionStorage.setItem('adminLoginRecorded', 'true');
      }
    });
    window.addEventListener('resize', setHeaderOffset);

    // Drag-safe overlay handling for Activity Log modal
    (function() {
      const modal = document.getElementById('activityLogModal');
      const box = modal ? modal.querySelector('.modal-content') : null;
      if (!modal) return;
      let overlayMouseDown = false;
      modal.addEventListener('mousedown', (e) => { overlayMouseDown = (e.target === modal); });
      modal.addEventListener('mouseup', (e) => {
        if (overlayMouseDown && e.target === modal) closeActivityLog();
        overlayMouseDown = false;
      });
      if (box) ['mousedown','mouseup','click'].forEach(evt => box.addEventListener(evt, (e) => e.stopPropagation()));
      const closer = document.querySelector('[data-close="activityLogModal"]');
      if (closer) closer.addEventListener('click', closeActivityLog);
    })();
  </script>
</body>
</html>
