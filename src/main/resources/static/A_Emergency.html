<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Emergency - BarangayConnect</title>

  <link rel="stylesheet" href="A_emergency-style.css">

  <style>
    * { scrollbar-width: none; -ms-overflow-style: none; }
    *::-webkit-scrollbar { display: none; }
  </style>

  <script src="https://kit.fontawesome.com/a2e0f1f0c1.js" crossorigin="anonymous"></script>
</head>

<body>
<div class="emergency-container">

  <!-- HEADER -->
  <div class="emergency-header">
    <h1 class="emergency-title">Emergency Contacts</h1>
  </div>

  <!-- CONTACTS MANAGEMENT -->
  <div class="contacts-management">
    <div class="section-title-wrapper">
      <h2 class="section-title">Emergency Contacts Management</h2>
    </div>

    <div class="management-actions">
      <button class="add-contact-btn" onclick="openAddContactModal()">
        <i class="fas fa-plus"></i> Add New Contact
      </button>
    </div>

    <div class="contacts-table-container">
      <div class="table-header">
        <div class="table-cell">SERVICE</div>
        <div class="table-cell">CONTACT NUMBER</div>
        <div class="table-cell">DESCRIPTION</div>
        <div class="table-cell">LAST UPDATED</div>
        <div class="table-cell">ACTIONS</div>
      </div>

      <div class="table-body">
        <!-- Contacts loaded here -->
      </div>
    </div>
  </div>

  <!-- PROCEDURES SECTION -->
  <div class="procedures-section">
    <div class="section-title-wrapper">
      <h2 class="section-title">Emergency Procedures</h2>
    </div>

    <div class="management-actions">
      <button class="add-contact-btn" onclick="openAddProcedureModal()">
        <i class="fas fa-plus"></i> Add New Procedure
      </button>
    </div>

    <div class="procedures-grid">
      <!-- Procedures loaded here -->
    </div>
  </div>

  <!-- ðŸ”¥ REMOVED HOTLINES SECTION COMPLETELY -->

  <!-- PROCEDURE EDIT MODAL -->
  <div class="modal-overlay" id="procedureEditModalOverlay">
    <div class="modal-wrapper">
      <div class="modal-header">
        <h3 id="procedureModalTitle"><i class="fas fa-edit"></i> Edit Procedure</h3>
        <button class="modal-close" id="procedureModalClose"><i class="fas fa-times"></i></button>
      </div>

      <form id="procedureEditForm" class="modal-form">
        <div class="form-group">
          <label>Title *</label>
          <input type="text" id="procedureEditTitle" required>
        </div>
        
        <div class="form-group">
          <label>Steps *</label>
          <textarea id="procedureEditSteps" rows="8" placeholder="1 step per line" required></textarea>
        </div>

        <div class="form-actions">
          <button type="button" class="secondary-btn" id="procedureCancelBtn">Cancel</button>
          <button type="submit" class="primary-btn" id="procedureSubmitBtn">Save</button>
        </div>
      </form>
    </div>
  </div>

  <!-- ðŸ”¥ REMOVED HOTLINE EDIT MODAL COMPLETELY -->

  <!-- CONTACT ADD/EDIT MODAL -->
  <div class="modal-overlay" id="contactEditModalOverlay">
    <div class="modal-wrapper">
      <div class="modal-header">
        <h3 id="contactModalTitle"><i class="fas fa-edit"></i> Contact</h3>
        <button class="modal-close" id="contactModalClose"><i class="fas fa-times"></i></button>
      </div>

      <form id="contactEditForm" class="modal-form">
        <div class="form-group">
          <label>Service Name *</label>
          <input type="text" id="contactEditName" required>
        </div>

        <div class="form-group">
          <label>Contact Number *</label>
          <input type="text" id="contactEditNumber" required>
        </div>

        <div class="form-group">
          <label>Description</label>
          <textarea id="contactEditDescription" rows="3"></textarea>
        </div>

        <div class="form-actions">
          <button type="button" class="secondary-btn" id="contactCancelBtn">Cancel</button>
          <button type="submit" class="primary-btn" id="contactSubmitBtn">Save</button>
        </div>
      </form>
    </div>
  </div>

  <!-- CONFIRM MODAL -->
  <div class="modal-overlay" id="confirmModalOverlay">
    <div class="modal-wrapper" style="max-width:450px;">
      <div class="modal-header">
        <h3><i class="fas fa-exclamation-triangle"></i> Confirm</h3>
        <button class="modal-close" id="confirmModalClose"><i class="fas fa-times"></i></button>
      </div>

      <div class="modal-form">
        <p id="confirmMessage"></p>
        <div class="form-actions">
          <button type="button" class="secondary-btn" id="confirmCancelBtn">Cancel</button>
          <button type="button" class="primary-btn" id="confirmOkBtn">OK</button>
        </div>
      </div>
    </div>
  </div>

<script>
/* ============================================================
   CONTACT API
   ============================================================*/
const CONTACT_API = "http://localhost:8080/api/emergency/contacts";

/* Fetch Contacts */
async function getEmergencyContacts() {
  const res = await fetch(CONTACT_API);
  return await res.json();
}

/* Save Contact */
async function saveEmergencyContact(contact) {
  await fetch(CONTACT_API, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(contact),
  });
}

/* Update Contact */
async function updateEmergencyContact(id, contact) {
  await fetch(`${CONTACT_API}/${id}`, {
    method: "PUT",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(contact),
  });
}

/* Delete Contact */
async function deleteEmergencyContactDB(id) {
  await fetch(`${CONTACT_API}/${id}`, { method: "DELETE" });
}

/* Icon Picker */
function getIconClass(name) {
  const s = name.toLowerCase();
  if (s.includes("medical") || s.includes("ambulance")) return "fa-ambulance";
  if (s.includes("fire")) return "fa-fire";
  if (s.includes("police")) return "fa-shield-alt";
  if (s.includes("barangay")) return "fa-building";
  if (s.includes("red cross") || s.includes("redcross")) return "fa-heart";
  if (s.includes("public works")) return "fa-tools";
  return "fa-phone";
}

/* ============================================================
   RENDER CONTACT TABLE
   ============================================================*/
async function renderEmergencyContacts() {
  const contacts = await getEmergencyContacts();
  const tableBody = document.querySelector(".table-body");

  tableBody.innerHTML = contacts
    .map(
      (c) => `
      <div class="table-row" data-row-id="${c.id}">
        <div class="table-cell service-info">
          <div class="service-info-content">
            <div class="service-icon"><i class="fas ${c.icon || getIconClass(c.serviceName)}"></i></div>
            <div class="service-details">
              <div class="service-name">${c.serviceName}</div>
            </div>
          </div>
        </div>

        <div class="table-cell contact-number">${c.contactNumber}</div>
        <div class="table-cell description">${c.description || ""}</div>
        <div class="table-cell last-updated">${c.lastUpdated || ""}</div>

        <div class="table-cell actions">
          <button class="action-btn edit-btn" onclick="openContactEditModal('${c.id}')">
            <i class="fas fa-edit"></i>
          </button>

          <!-- FIXED: deleteEmergencyContact now receives a NUMBER instead of STRING -->
          <button class="action-btn contact-delete-btn" onclick="deleteEmergencyContact(${c.id})">
            <i class="fas fa-trash"></i>
          </button>

        </div>
      </div>`
    )
    .join("");
}

/* ============================================================
   CONFIRM MODAL
   ============================================================*/
let confirmCallback = null;

function showConfirmModal(message, callback) {
  document.getElementById("confirmMessage").textContent = message;
  confirmCallback = callback;
  document.getElementById("confirmModalOverlay").style.display = "flex";
}

function closeConfirmModal() {
  document.getElementById("confirmModalOverlay").style.display = "none";
  confirmCallback = null;
}

document.getElementById("confirmOkBtn").onclick = () => {
  if (confirmCallback) confirmCallback();
  closeConfirmModal();
};

document.getElementById("confirmCancelBtn").onclick =
document.getElementById("confirmModalClose").onclick = closeConfirmModal;

/* ============================================================
   DELETE CONTACT
   ============================================================*/
function deleteEmergencyContact(id) {
  showConfirmModal("Delete this contact?", async () => {
    await deleteEmergencyContactDB(id);
    renderEmergencyContacts();
  });
}

/* ============================================================
   CONTACT EDIT / ADD MODAL
   ============================================================*/
let currentEditContactId = null;

/* OPEN ADD MODAL */
function openAddContactModal() {
  currentEditContactId = null;

  contactModalTitle.innerHTML = "<i class='fas fa-plus'></i> Add Contact";
  contactSubmitBtn.textContent = "Add Contact";

  contactEditName.value = "";
  contactEditNumber.value = "";
  contactEditDescription.value = "";

  contactEditModalOverlay.style.display = "flex";
}

/* OPEN EDIT MODAL */
async function openContactEditModal(id) {
  currentEditContactId = id;

  const contacts = await getEmergencyContacts();
  const c = contacts.find((x) => x.id == id);

  contactModalTitle.innerHTML = "<i class='fas fa-edit'></i> Edit Contact";
  contactSubmitBtn.textContent = "Save Changes";

  contactEditName.value = c.serviceName;
  contactEditNumber.value = c.contactNumber;
  contactEditDescription.value = c.description || "";

  contactEditModalOverlay.style.display = "flex";
}

/* CLOSE CONTACT MODAL */
document.getElementById("contactModalClose").onclick =
document.getElementById("contactCancelBtn").onclick = () => {
  contactEditModalOverlay.style.display = "none";
};

/* ============================================================
   SAVE CONTACT
   ============================================================*/
contactEditForm.addEventListener("submit", async (e) => {
  e.preventDefault();

  const serviceName = contactEditName.value.trim();
  const contactNumber = contactEditNumber.value.trim();
  const description = contactEditDescription.value.trim();

  if (!serviceName || !contactNumber) return alert("Required fields missing.");

  const now = new Date().toLocaleDateString("en-US", {
    year: "numeric",
    month: "long",
    day: "numeric",
  });

  const payload = {
    serviceName,
    contactNumber,
    description,
    lastUpdated: now,
    icon: getIconClass(serviceName),
  };

  if (currentEditContactId) {
    await updateEmergencyContact(currentEditContactId, payload);
  } else {
    await saveEmergencyContact(payload);
  }

  contactEditModalOverlay.style.display = "none";
  renderEmergencyContacts();
});

/* ðŸ”¥ REMOVED ALL HOTLINE JAVASCRIPT HERE */

/* ============================================================
   PROCEDURE API
   ============================================================*/
const PROCEDURE_API = "http://localhost:8080/api/emergency/procedures";

/* Fetch Procedures */
async function getEmergencyProcedures() {
  const res = await fetch(PROCEDURE_API);
  return await res.json();
}

/* Save Procedure */
async function saveEmergencyProcedure(proc) {
  await fetch(PROCEDURE_API, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(proc),
  });
}

/* Update Procedure */
async function updateEmergencyProcedure(id, proc) {
  await fetch(`${PROCEDURE_API}/${id}`, {
    method: "PUT",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(proc),
  });
}

/* Delete Procedure */
async function deleteEmergencyProcedureDB(id) {
  await fetch(`${PROCEDURE_API}/${id}`, { method: "DELETE" });
}

/* Icon Picker */
function getProcedureIcon(title) {
  const t = title.toLowerCase();
  if (t.includes("fire") || t.includes("burn")) return "fa-fire";
  if (t.includes("medical") || t.includes("injury")) return "fa-first-aid";
  if (t.includes("earthquake") || t.includes("quake")) return "fa-house-damage";
  if (t.includes("flood") || t.includes("water")) return "fa-water";
  if (t.includes("storm") || t.includes("typhoon")) return "fa-cloud-showers-heavy";
  return "fa-exclamation-circle";
}

/* ============================================================
   DOM ELEMENTS
   ============================================================*/
const procedureModalTitle = document.getElementById("procedureModalTitle");
const procedureSubmitBtn = document.getElementById("procedureSubmitBtn");
const procedureEditTitle = document.getElementById("procedureEditTitle");
const procedureEditSteps = document.getElementById("procedureEditSteps");
const procedureEditModalOverlay = document.getElementById("procedureEditModalOverlay");
const procedureModalClose = document.getElementById("procedureModalClose");
const procedureCancelBtn = document.getElementById("procedureCancelBtn");
const procedureEditForm = document.getElementById("procedureEditForm");
const proceduresGrid = document.querySelector(".procedures-grid");

let currentProcedureId = null;

/* ============================================================
   RENDER PROCEDURE CARDS
   ============================================================*/
async function renderEmergencyProcedures() {
  const procedures = await getEmergencyProcedures();

  proceduresGrid.innerHTML = procedures
    .map(
      (p) => `
      <div class="procedure-card" data-id="${p.id}">
        <div class="procedure-icon">
          <i class="fas ${p.icon || getProcedureIcon(p.title)}"></i>
        </div>
        <div class="procedure-content">
          <h3 class="procedure-title">${p.title}</h3>
         <ol class="procedure-steps">
  ${JSON.parse(p.steps).map((s) => `<li>${s}</li>`).join("")}
</ol>

        </div>
        <div class="procedure-actions">
          <button class="action-btn edit-btn" data-id="${p.id}">
            <i class="fas fa-edit"></i>
          </button>
          <button class="action-btn procedure-delete-btn" data-id="${p.id}">
            <i class="fas fa-trash"></i>
          </button>
        </div>
      </div>`
    )
    .join("");

  document.querySelectorAll(".edit-btn").forEach((btn) =>
    btn.addEventListener("click", () => openProcedureEditModal(btn.dataset.id))
  );

  document.querySelectorAll(".procedure-delete-btn").forEach((btn) =>
    btn.addEventListener("click", () => deleteEmergencyProcedure(btn.dataset.id))
  );
}

/* ============================================================
   DELETE PROCEDURE
   ============================================================*/
function deleteEmergencyProcedure(id) {
  showConfirmModal("Delete this procedure?", async () => {
    await deleteEmergencyProcedureDB(id);
    renderEmergencyProcedures();
  });
}

/* ============================================================
   ADD / EDIT PROCEDURE MODAL
   ============================================================*/
function openAddProcedureModal() {
  currentProcedureId = null;

  procedureModalTitle.innerHTML = "<i class='fas fa-plus'></i> Add Procedure";
  procedureSubmitBtn.textContent = "Add Procedure";

  procedureEditTitle.value = "";
  procedureEditSteps.value = "";

  procedureEditModalOverlay.style.display = "flex";
}

async function openProcedureEditModal(id) {
  currentProcedureId = id;

  const procedures = await getEmergencyProcedures();
  const p = procedures.find((x) => x.id == id);
  if (!p) return alert("Procedure not found");

  procedureModalTitle.innerHTML = "<i class='fas fa-edit'></i> Edit Procedure";
  procedureSubmitBtn.textContent = "Save Changes";

  procedureEditTitle.value = p.title;
  procedureEditSteps.value = JSON.parse(p.steps).join("\n");

  procedureEditModalOverlay.style.display = "flex";
}

/* CLOSE PROCEDURE MODAL */
procedureModalClose.onclick =
procedureCancelBtn.onclick = () => {
  procedureEditModalOverlay.style.display = "none";
};

/* ============================================================
   SAVE PROCEDURE
   ============================================================*/
procedureEditForm.addEventListener("submit", async (e) => {
  e.preventDefault();

  const title = procedureEditTitle.value.trim();
  const steps = procedureEditSteps.value
    .split("\n")
    .map((s) => s.trim())
    .filter((s) => s.length > 0);

  if (!title || steps.length === 0) return alert("Complete all required fields.");

  const payload = {
    title,
    steps: JSON.stringify(steps),
    icon: getProcedureIcon(title),
  };

  if (currentProcedureId) {
    await updateEmergencyProcedure(currentProcedureId, payload);
  } else {
    await saveEmergencyProcedure(payload);
  }

  procedureEditModalOverlay.style.display = "none";
  renderEmergencyProcedures();
});

/* ============================================================
   INITIAL LOAD
   ============================================================*/
document.addEventListener("DOMContentLoaded", () => {
  renderEmergencyContacts();
  renderEmergencyProcedures();
});
</script>

</body>
</html>
