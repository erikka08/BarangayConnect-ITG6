<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>BarangayConnect - Resident Portal</title>
  <link rel="stylesheet" href="resident-style.css" />
  <script src="https://kit.fontawesome.com/a2e0f1f0c1.js" crossorigin="anonymous"></script>
  <style>
    /* Global scrollbar hiding for all elements */
    * {
      scrollbar-width: none !important; /* Firefox */
      -ms-overflow-style: none !important; /* Internet Explorer 10+ */
    }
    
    *::-webkit-scrollbar {
      display: none !important; /* WebKit */
    }
    
    /* Ensure iframes don't show scrollbars */
    iframe {
      scrollbar-width: none !important;
      -ms-overflow-style: none !important;
    }
    
    iframe::-webkit-scrollbar {
      display: none !important;
    }
  </style>
</head>
<body class="admin-body">

  <!-- Admin Header -->
  <header class="admin-header">
    <div class="header-left">
      <h1>
        <span class="brand-logo" aria-hidden="true"><img src="BC_House.png" alt="BarangayConnect logo" /></span>
        BarangayConnect
      </h1>
    </div>
    <div class="header-right">
      <div class="settings-dropdown">
        <button class="header-btn" title="Settings" onclick="toggleSettings()"><i class="fas fa-cog"></i></button>
        <div class="settings-menu" id="settingsMenu">
          <a href="#" class="settings-item" onclick="openUpdateProfile()">
            <i class="fas fa-user-edit"></i>
            <span>Update Profile</span>
          </a>
          <a href="#" class="settings-item" onclick="logout()">
            <i class="fas fa-sign-out-alt"></i>
            <span>Log out</span>
          </a>
        </div>
      </div>
    </div>
  </header>

  <!-- Admin Container -->
  <div class="admin-container">
    <!-- Modern Sidebar -->
    <aside class="modern-sidebar" aria-label="Primary">
      <div class="sidebar-toggle" onclick="toggleSidebar()">
        <div class="hamburger">
          <span></span>
          <span></span>
          <span></span>
        </div>
      </div>
      
      <div class="sidebar-content">
      <div class="sidebar-header">
        <div class="user-info">
            <div class="user-details">
              <h3 id="user-greeting">Hello, Resident!</h3>
              <p id="user-id-line"></p>
              <p>Community Member</p>
            </div>
          </div>
        </div>
        
        <nav class="sidebar-nav">
          <ul class="nav-list">
            <li class="nav-item active">
              <a href="#" class="nav-link" data-section="dashboard">
                <i class="fas fa-home"></i>
                <span>Home</span>
              </a>
            </li>
            <li class="nav-item">
              <a href="#" class="nav-link" data-section="reports">
                <i class="fas fa-file-invoice"></i>
                <span>Reports</span>
              </a>
            </li>
            <li class="nav-item">
              <a href="#" class="nav-link" data-section="requests">
                <i class="fas fa-file-alt"></i>
                <span>Requests</span>
              </a>
            </li>
            <li class="nav-item">
              <a href="#" class="nav-link" data-section="transparency">
                <i class="fas fa-balance-scale"></i>
                <span>Transparency</span>
              </a>
            </li>
            <li class="nav-item">
              <a href="#" class="nav-link" data-section="announcements">
                <i class="fas fa-bullhorn"></i>
                <span>Announcements</span>
              </a>
            </li>
            <li class="nav-item">
              <a href="#" class="nav-link" data-section="emergency">
                <i class="fas fa-phone"></i>
                <span>Emergency</span>
              </a>
            </li>
          </ul>
        </nav>
        
      </div>
    </aside>

    <!-- Main Content Area -->
    <main class="admin-main">
      <div class="main-content">
        <!-- Content sections will be loaded dynamically -->
        <div id="dashboard-section" class="content-section active">
          <iframe src="R_Home-Dashboard.html" frameborder="0" width="100%" height="100%" style="border: none; height: 100vh; margin: 0; padding: 0; display: block; overflow: hidden;"></iframe>
        </div>

        <div id="announcements-section" class="content-section">
          <iframe src="R_Announcements.html" frameborder="0" width="100%" height="100%" style="border: none; height: 100vh; margin: 0; padding: 0; display: block; overflow: hidden;"></iframe>
        </div>

        <div id="emergency-section" class="content-section">
          <iframe src="R_Emergency.html" frameborder="0" width="100%" height="100%" style="border: none; height: 100vh; margin: 0; padding: 0; display: block; overflow: hidden;"></iframe>
        </div>

        <div id="reports-section" class="content-section">
          <iframe src="R_Reports.html" frameborder="0" width="100%" height="100%" style="border: none; height: 100vh; margin: 0; padding: 0; display: block; overflow: hidden;"></iframe>
        </div>

        <div id="requests-section" class="content-section">
          <iframe src="R_Request-management.html" frameborder="0" width="100%" height="100%" style="border: none; height: 100vh; margin: 0; padding: 0; display: block; overflow: hidden;"></iframe>
        </div>

        <div id="transparency-section" class="content-section">
          <iframe src="R_Transparency.html" frameborder="0" width="100%" height="100%" style="border: none; height: 100vh; margin: 0; padding: 0; display: block; overflow: hidden;"></iframe>
        </div>
      </div>
    </main>
  </div>

  <!-- Update Profile Modal -->
  <div id="updateProfileModal" class="modal">
    <div class="modal-content profile-modal">
      <span class="close" data-close="updateProfileModal">&times;</span>
      <h2><i class="fas fa-user-edit"></i> Update Profile</h2>
      
      <form id="updateProfileForm">
        <!-- Personal Information -->
        <div class="form-section">
          <h3><i class="fas fa-user"></i> Personal Information</h3>
          
          <div class="form-row">
            <div class="form-group">
              <label><i class="fas fa-user"></i> First Name</label>
              <input type="text" id="firstName" name="firstName" placeholder="Enter your first name" required>
            </div>
            <div class="form-group">
              <label><i class="fas fa-user"></i> Last Name</label>
              <input type="text" id="lastName" name="lastName" placeholder="Enter your last name" required>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label><i class="fas fa-envelope"></i> Email Address</label>
              <input type="email" id="email" name="email" placeholder="Enter your email address" required>
            </div>
            <div class="form-group">
              <label><i class="fas fa-phone"></i> Mobile Number</label>
              <input type="tel" id="mobile" name="mobile" placeholder="Enter your mobile number" required>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label><i class="fas fa-calendar"></i> Date of Birth</label>
              <input type="date" id="dateOfBirth" name="dateOfBirth" required>
            </div>
            <div class="form-group">
              <label><i class="fas fa-venus-mars"></i> Gender</label>
              <select id="gender" name="gender" required>
                <option value="">Select Gender</option>
                <option value="male">Male</option>
                <option value="female">Female</option>
                <option value="other">Other</option>
              </select>
            </div>
          </div>
        </div>

        <!-- Address Information -->
        <div class="form-section">
          <h3><i class="fas fa-map-marker-alt"></i> Address Information</h3>
          
          <div class="form-group">
            <label><i class="fas fa-home"></i> House Number & Street</label>
            <input type="text" id="street" name="street" placeholder="Enter house number and street" required>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label><i class="fas fa-building"></i> Barangay</label>
              <input type="text" id="barangay" name="barangay" value="Tambo" readonly>
            </div>
            <div class="form-group">
              <label><i class="fas fa-city"></i> City</label>
              <input type="text" id="city" name="city" value="Parañaque City" readonly>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label><i class="fas fa-map"></i> Postal Code</label>
              <input type="text" id="postalCode" name="postalCode" placeholder="Enter postal code" required>
            </div>
            <div class="form-group">
              <label><i class="fas fa-flag"></i> Province</label>
              <input type="text" id="province" name="province" value="Metro Manila" readonly>
            </div>
          </div>
        </div>

        <!-- Emergency Contact -->
        <div class="form-section">
          <h3><i class="fas fa-phone-alt"></i> Emergency Contact</h3>
          
          <div class="form-row">
            <div class="form-group">
              <label><i class="fas fa-user-friends"></i> Emergency Contact Name</label>
              <input type="text" id="emergencyName" name="emergencyName" placeholder="Enter emergency contact name" required>
            </div>
            <div class="form-group">
              <label><i class="fas fa-phone"></i> Emergency Contact Number</label>
              <input type="tel" id="emergencyNumber" name="emergencyNumber" placeholder="Enter emergency contact number" required>
            </div>
          </div>

          <div class="form-group">
            <label><i class="fas fa-link"></i> Relationship</label>
            <select id="emergencyRelationship" name="emergencyRelationship" required>
              <option value="">Select Relationship</option>
              <option value="spouse">Spouse</option>
              <option value="parent">Parent</option>
              <option value="sibling">Sibling</option>
              <option value="child">Child</option>
              <option value="friend">Friend</option>
              <option value="other">Other</option>
            </select>
          </div>
        </div>

        <!-- Form Actions -->
        <div class="form-actions">
          <button type="button" class="cancel-btn" onclick="closeUpdateProfile()">Cancel</button>
          <button type="submit" class="save-btn">
            <i class="fas fa-save"></i> Save Changes
          </button>
        </div>
      </form>
    </div>
  </div>

 <script>

    /* ============================================================
       ✨ CHANGED: Backend approval checking instead of localStorage
       ============================================================ */

    // ❌ REMOVED old checkPendingUser() — it blocks approved users
    // REPLACED with database-based checker below

    (async function checkResidentFromDatabase() {   // ✅ ADDED
        const residentId = localStorage.getItem("residentId");

        // If no login stored → go to front
        if (!residentId) {
            window.location.href = "../Front.html";
            return;
        }

        try {
            // Fetch from your database API
            const res = await fetch(`http://localhost:8080/api/resident/${residentId}`);

            if (!res.ok) {
                window.location.href = "../Front.html";
                return;
            }

            const user = await res.json();
            window.currentResident = user;   // ✔ store active resident globally

            // PENDING user → send back to waiting room
            if (user.status === "PENDING") {
                window.location.href = "R_Waiting.html";
                return;
            }

            // ACTIVE user allowed only
            if (user.status !== "ACTIVE") {
                window.location.href = "../Front.html";
                return;
            }

 // ✨ FIXED GREETING BASED ON YOUR DATABASE COLUMNS
const greetName = user.firstname || "Resident";
const greetId = user.id || "—";

document.getElementById("user-greeting").textContent = `Hello, ${greetName}!`;
document.getElementById("user-id-line").textContent = `ID: ${greetId}`;



        } catch (err) {
            console.error("Backend error:", err);
            window.location.href = "../Front.html";
        }
    })();



    /* ============================================================
       (UNCHANGED) — Sidebar navigation
       ============================================================ */

    document.querySelectorAll('.nav-link').forEach(link => {
      link.addEventListener('click', function(e) {
        e.preventDefault();
        document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
        this.parentElement.classList.add('active');
        document.querySelectorAll('.content-section').forEach(section => section.classList.remove('active'));
        const sectionId = this.getAttribute('data-section') + '-section';
        const targetSection = document.getElementById(sectionId);
        if (targetSection) targetSection.classList.add('active');
      });
    });



    /* ============================================================
       (UNCHANGED) — Settings Menu + Logout
       ============================================================ */

    function toggleSettings() {
      const settingsMenu = document.getElementById('settingsMenu');
      settingsMenu.classList.toggle('show');
    }

    document.addEventListener('click', function(event) {
      const settingsDropdown = document.querySelector('.settings-dropdown');
      const settingsMenu = document.getElementById('settingsMenu');
      if (!settingsDropdown.contains(event.target)) settingsMenu.classList.remove('show');
    });

    function logout() {
      localStorage.removeItem("residentId");  // ✔ keep this
      window.location.href = '../Front.html';
    }



    /* ============================================================
       ✨ CHANGED — Populate Update Profile from DATABASE not localStorage
       ============================================================ */

    function openUpdateProfile() {
      console.log('Opening Update Profile modal...');
      document.getElementById('settingsMenu').classList.remove('show');
      const modal = document.getElementById('updateProfileModal');

      if (modal) {
        modal.style.display = 'block';

        const u = window.currentResident;   // ✔ load from DB, NOT localStorage

        // Fill form using DB data
        document.getElementById('firstName').value = u.firstName;
        document.getElementById('lastName').value = u.lastName;
        document.getElementById('email').value = u.email;
        document.getElementById('mobile').value = u.mobile;
        document.getElementById('dateOfBirth').value = u.dateOfBirth;
        document.getElementById('gender').value = u.gender;
        document.getElementById('street').value = u.street;
        document.getElementById('postalCode').value = u.postalCode;
        document.getElementById('emergencyName').value = u.emergencyName;
        document.getElementById('emergencyNumber').value = u.emergencyNumber;
        document.getElementById('emergencyRelationship').value = u.emergencyRelationship;

      } else {
        console.error("Modal not found");
      }
    }

    function closeUpdateProfile() {
      document.getElementById('updateProfileModal').style.display = 'none';
    }



    /* ============================================================
       ✨ CHANGED — UPDATE PROFILE VIA DATABASE
       ============================================================ */

    document.getElementById('updateProfileForm').addEventListener('submit', async function(e) {
        e.preventDefault();

        // Validation (UNCHANGED)
        const requiredFields = ['firstName', 'lastName', 'email', 'mobile', 'dateOfBirth', 'gender', 'street', 'postalCode', 'emergencyName', 'emergencyNumber', 'emergencyRelationship'];
        let isValid = true;
        requiredFields.forEach(field => {
            const input = document.getElementById(field);
            if (!input.value.trim()) {
                input.style.borderColor = '#e74c3c';
                isValid = false;
            } else {
                input.style.borderColor = '#e0e0e0';
            }
        });
        if (!isValid) {
            alert('Please fill in all required fields.');
            return;
        }

        // Build update object
        const residentId = localStorage.getItem("residentId");

        const updatedData = {    // ✅ ADDED (using DB format)
            firstName: firstName.value,
            lastName: lastName.value,
            email: email.value,
            mobile: mobile.value,
            dateOfBirth: dateOfBirth.value,
            gender: gender.value,
            street: street.value,
            postalCode: postalCode.value,
            emergencyName: emergencyName.value,
            emergencyNumber: emergencyNumber.value,
            emergencyRelationship: emergencyRelationship.value
        };

        try {
            // Send update to backend
            const res = await fetch(`http://localhost:8080/api/resident/update/${residentId}`, {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(updatedData)
            });

            if (!res.ok) {
                alert("Error updating profile!");
                return;
            }

            alert("Profile updated successfully!");

            // Refresh current user data from DB
            const refreshed = await fetch(`http://localhost:8080/api/resident/${residentId}`);
            window.currentResident = await refreshed.json();   // ✔ updated

            // Update greeting
            document.getElementById("user-greeting").textContent =
                `Hello, ${window.currentResident.firstName}!`;

            closeUpdateProfile();

        } catch (err) {
            console.error("Update error:", err);
        }
    });



    /* ============================================================
       (UNCHANGED) Sidebar Toggle, Layout, Heartbeat, Modal Close
       ============================================================ */

    function toggleSidebar() {
      document.querySelector('.modern-sidebar').classList.toggle('collapsed');
    }

    document.addEventListener('DOMContentLoaded', function() {
      const hamburgerIcon = document.querySelector('.sidebar-toprow i.fa-bars');
      if (hamburgerIcon) {
        hamburgerIcon.addEventListener('click', toggleSidebar);
        hamburgerIcon.style.cursor = 'pointer';
      }
    });

    function setHeaderOffset() {
      var header = document.querySelector('.admin-header');
      if (!header) return;
      var borderBottom = 3;
      var offset = header.offsetHeight + borderBottom;
      document.documentElement.style.setProperty('--header-offset', offset + 'px');
    }

    function setCurrentDate() {
      var dateElement = document.getElementById('current-date');
      if (dateElement) {
        var today = new Date();
        var options = { weekday:'long', year:'numeric', month:'long', day:'numeric' };
        dateElement.textContent = today.toLocaleDateString('en-US', options);
      }
    }

    window.addEventListener('load', function() {
      setHeaderOffset();
      setCurrentDate();
    });

    window.addEventListener('resize', setHeaderOffset);

    (function() {
      const modal = document.getElementById('updateProfileModal');
      const box = modal ? modal.querySelector('.modal-content') : null;
      if (!modal) return;
      let overlayMouseDown = false;
      modal.addEventListener('mousedown', e => overlayMouseDown = (e.target === modal));
      modal.addEventListener('mouseup', e => {
        if (overlayMouseDown && e.target === modal) closeUpdateProfile();
        overlayMouseDown = false;
      });
      if (box) ['mousedown','mouseup','click'].forEach(evt => box.addEventListener(evt,e=>e.stopPropagation()));
      const closer = document.querySelector('[data-close="updateProfileModal"]');
      if (closer) closer.addEventListener('click', closeUpdateProfile);
    })();

</script>
