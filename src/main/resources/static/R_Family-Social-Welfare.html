<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Family, Social & Welfare - BarangayConnect</title>
  <link rel="stylesheet" href="R_Family-Social-Welfare-style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <script src="https://kit.fontawesome.com/a2e0f1f0c1.js" crossorigin="anonymous"></script>
  <style>
    * { scrollbar-width: none !important; -ms-overflow-style: none !important; }
    *::-webkit-scrollbar { display: none !important; }
    body {
      overflow-x: visible !important;
      min-width: 100% !important;
      padding-top: 2rem !important;
      padding-bottom: 2rem !important;
    }
    .request-container { min-width: 100% !important; overflow: visible !important; padding-top: 1rem !important; }
    .page-header { min-width: 100% !important; overflow: visible !important; margin-top: 1rem !important; padding: 1rem 0 !important; }
  </style>
</head>
<body>
  <div class="request-container">

    <!-- Page Header -->
    <div class="page-header">
      <div class="header-content">
        <button class="back-btn" onclick="goBack()" title="Back to Request Management">
          <i class="fas fa-arrow-left"></i>
        </button>
        <div class="header-text">
          <h1 class="page-title"><i class="fas fa-people-group"></i> Family, Social & Welfare</h1>
          <p class="page-subtitle">Request family assistance, social welfare, and endorsement documents</p>
        </div>
      </div>
    </div>

    <div class="content-wrapper">

      <!-- Request Form Section -->
      <div class="form-section">
        <div class="form-card">
          <h2 class="form-title"><i class="fas fa-file-signature"></i> Request Form</h2>

          <form id="requestForm" class="request-form">

            <!-- Document Type -->
            <div class="form-group">
              <label for="documentType" class="form-label"><i class="fas fa-file-alt"></i> Document Type <span class="required">*</span></label>
              <select id="documentType" name="documentType" class="form-select" required>
                <option value="">Select a document type...</option>
                <option value="solo-parent">Certificate of Solo Parent</option>
                <option value="guardianship">Certificate of Guardianship</option>
                <option value="marriage-requirements">Certificate for Marriage Requirements</option>
                <option value="joint-affidavits">Joint Affidavits related to family matters</option>
                <option value="indigency">Certificate of Indigency</option>
                <option value="financial-assistance">Financial Assistance Request Endorsement</option>
                <option value="medical-assistance">Medical Assistance Endorsement</option>
                <option value="scholarship">Scholarship Endorsement</option>
                <option value="senior-citizen-id">Senior Citizen ID Endorsement</option>
              </select>
            </div>

            <!-- Personal Info -->
            <div class="form-row">
              <div class="form-group">
                <label class="form-label"><i class="fas fa-user"></i> First Name <span class="required">*</span></label>
                <input type="text" id="firstName" name="firstName" class="form-input" required>
              </div>

              <div class="form-group">
                <label class="form-label"><i class="fas fa-user"></i> Last Name <span class="required">*</span></label>
                <input type="text" id="lastName" name="lastName" class="form-input" required>
              </div>
            </div>

            <div class="form-group">
              <div class="label-row">
                <label class="form-label"><i class="fas fa-user"></i> Middle Name</label>
                <label class="checkbox-label">
                  <input type="checkbox" id="middleNameNA">
                  <span>N/A</span>
                </label>
              </div>
              <input type="text" id="middleName" name="middleName" class="form-input">
            </div>

            <div class="form-group">
              <label class="form-label"><i class="fas fa-calendar"></i> Birthdate <span class="required">*</span></label>
              <input type="date" id="birthdate" name="birthdate" class="form-input" required>
            </div>

            <div class="form-group">
              <label class="form-label"><i class="fas fa-map-marker-alt"></i> Complete Address <span class="required">*</span></label>
              <textarea id="address" name="address" class="form-textarea" required></textarea>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label class="form-label"><i class="fas fa-phone"></i> Contact Number <span class="required">*</span></label>
                <input type="tel" id="contactNumber" name="contactNumber" class="form-input" required>
              </div>

              <div class="form-group">
                <label class="form-label"><i class="fas fa-envelope"></i> Email</label>
                <input type="email" id="email" name="email" class="form-input">
              </div>
            </div>

            <!-- File Uploads -->
            <div class="form-group">
              <label class="form-label"><i class="fas fa-upload"></i> Upload Requirements <span class="required">*</span></label>

              <div class="upload-section">
                <div class="upload-item">
                  <label class="upload-label" for="validId"><i class="fas fa-id-badge"></i> Valid ID</label>
                  <input type="file" id="validId" class="file-input" accept="image/*,.pdf" required>
                </div>

                <div class="upload-item">
                  <label class="upload-label" for="proofRelationship"><i class="fas fa-users"></i> Proof of Relationship</label>
                  <input type="file" id="proofRelationship" class="file-input" accept="image/*,.pdf">
                </div>

                <div class="upload-item">
                  <label class="upload-label" for="supportingDocs"><i class="fas fa-file-alt"></i> Supporting Documents</label>
                  <input type="file" id="supportingDocs" class="file-input" accept="image/*,.pdf">
                </div>

                <div class="upload-item">
                  <label class="upload-label" for="barangayResidency"><i class="fas fa-home"></i> Barangay Residency Record</label>
                  <input type="file" id="barangayResidency" class="file-input" accept="image/*,.pdf" required>
                </div>

                <div class="upload-item">
                  <label class="upload-label" for="lowIncomeProof"><i class="fas fa-hand-holding-heart"></i> Proof of Low-Income Status</label>
                  <input type="file" id="lowIncomeProof" class="file-input" accept="image/*,.pdf">
                </div>

                <div class="upload-item">
                  <label class="upload-label" for="medicalSchoolDocs"><i class="fas fa-file-medical"></i> Medical or School Documents</label>
                  <input type="file" id="medicalSchoolDocs" class="file-input" accept="image/*,.pdf">
                </div>

                <div class="upload-item">
                  <label class="upload-label" for="applicationForm"><i class="fas fa-file-signature"></i> Application / Endorsement Form</label>
                  <input type="file" id="applicationForm" class="file-input" accept="image/*,.pdf">
                </div>
              </div>
            </div>

            <div class="form-group">
              <label class="form-label"><i class="fas fa-comment-alt"></i> Additional Notes</label>
              <textarea id="notes" name="notes" class="form-textarea"></textarea>
            </div>

            <div class="form-actions">
              <button type="button" class="btn btn-secondary" onclick="goBack()"><i class="fas fa-times"></i> Cancel</button>
              <button type="submit" class="btn btn-primary"><i class="fas fa-paper-plane"></i> Submit Request</button>
            </div>

          </form>
        </div>
      </div>

      <div class="info-card payment-card">
        <h2 class="section-title"><i class="fas fa-money-bill-wave"></i> Payment Fee</h2>
        <p class="payment-note">Payment fee will be determined based on the selected document type.</p>
        <p class="payment-contact">Please contact the barangay office for exact fee amounts.</p>
      </div>

    </div>
  </div>

  <script>
function goBack() { 
  window.location.href = 'R_Request-management.html'; 
}

document.addEventListener('DOMContentLoaded', function () {
  const form = document.getElementById('requestForm');
  if (!form) return;

  form.addEventListener('submit', async function (e) {
    e.preventDefault();

    console.log("Submitting Family & Welfare Request...");

    const documentType = document.getElementById('documentType').value;
    if (!documentType) return alert("Please select a document type.");

    const residentId = localStorage.getItem("residentId");
    if (!residentId) {
      alert("Error: No logged-in resident found.");
      return;
    }

    const firstName = document.getElementById('firstName').value;
    const lastName = document.getElementById('lastName').value;
    const birthdate = document.getElementById('birthdate').value;
    const address = document.getElementById('address').value;
    const contactNumber = document.getElementById('contactNumber').value;

    const validIdFile = document.getElementById('validId').files[0];
    const barangayResidencyFile = document.getElementById('barangayResidency').files[0];

    if (!firstName || !lastName || !birthdate || !address || !contactNumber) {
      return alert("Please fill all required fields.");
    }

    if (!validIdFile || !barangayResidencyFile) {
      return alert("Please upload both Valid ID and Barangay Residency Record.");
    }

    /* ================================
       ðŸ”§ FIX 1: NORMALIZED DOCUMENT TYPE
    ================================ */
    const documentTypeMap = {
      'solo-parent': 'Certificate of Solo Parent',
      'guardianship': 'Certificate of Guardianship',
      'marriage-requirements': 'Certificate for Marriage Requirements',
      'joint-affidavits': 'Joint Affidavits related to family matters',
      'indigency': 'Certificate of Indigency',
      'financial-assistance': 'Financial Assistance Request Endorsement',
      'medical-assistance': 'Medical Assistance Endorsement',
      'scholarship': 'Scholarship Endorsement',
      'senior-citizen-id': 'Senior Citizen ID Endorsement'
    };

    /* ================================
       ðŸ”§ FIX 2: JSON PAYLOAD ONLY (NO FILE METADATA)
    ================================ */
    const requestData = {
      residentId: residentId,
      firstName: firstName,
      middleName: document.getElementById('middleName').value || "",
      lastName: lastName,
      email: document.getElementById('email').value || "",
      mobile: contactNumber,
      address: address,
      birthdate: birthdate,
      documentType: documentTypeMap[documentType] || documentType,
      requestNotes: document.getElementById('notes').value || "",
      submissionDate: new Date().toISOString()
    };

    /* ================================
       ðŸ”§ FIX 3: MULTIPART FORM DATA
    ================================ */
    const multipart = new FormData();

    multipart.append(
      "data",
      new Blob([JSON.stringify(requestData)], { type: "application/json" })
    );

    /* ================================
       ðŸ”§ FIX 4: SEND REAL FILE BYTES
    ================================ */
    multipart.append("files", validIdFile);
    multipart.append("files", barangayResidencyFile);

    const optionalFiles = [
      "proofRelationship",
      "supportingDocs",
      "lowIncomeProof",
      "medicalSchoolDocs",
      "applicationForm"
    ];

    optionalFiles.forEach(id => {
      const file = document.getElementById(id).files[0];
      if (file) multipart.append("files", file);
    });

    /* ================================
       ðŸ”§ FIX 5: CORRECT BACKEND ENDPOINT
    ================================ */
    try {
      const res = await fetch("http://localhost:8080/api/requests/submit", {
        method: "POST",
        body: multipart
      });

      if (!res.ok) throw new Error("Submission failed");

      alert("Your request has been submitted successfully!");
      window.location.href = "R_Request-management.html";

    } catch (err) {
      console.error(err);
      alert("There was an error submitting your request.");
    }
  });

  /* ================================
     FILE NAME DISPLAY (UNCHANGED)
  ================================ */
  document.querySelectorAll('.file-input').forEach(input => {
    input.addEventListener('change', function () {
      const file = this.files[0];
      if (file) {
        const label = this.closest('.upload-item').querySelector('.upload-label');
        if (!label) return;
        const name = file.name.length > 30 ? file.name.slice(0, 30) + "..." : file.name;
        label.innerHTML = `<i class="fas fa-check-circle"></i> ${name}`;
        label.style.color = "var(--clr-1)";
      }
    });
  });

  /* ================================
     MIDDLE NAME N/A (UNCHANGED)
  ================================ */
  const middleNameNA = document.getElementById('middleNameNA');
  if (middleNameNA) {
    middleNameNA.addEventListener('change', function () {
      const middle = document.getElementById('middleName');
      if (!middle) return;

      if (this.checked) {
        middle.value = "N/A";
        middle.disabled = true;
        middle.style.backgroundColor = "#f8f9fa";
        middle.style.cursor = "not-allowed";
      } else {
        middle.value = "";
        middle.disabled = false;
        middle.style.backgroundColor = "white";
        middle.style.cursor = "text";
      }
    });
  }
});
</script>
