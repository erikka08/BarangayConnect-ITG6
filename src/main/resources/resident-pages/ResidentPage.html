<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>BarangayConnect - Resident Portal</title>
  <link rel="stylesheet" href="resident-style.css" />
  <script src="https://kit.fontawesome.com/a2e0f1f0c1.js" crossorigin="anonymous"></script>
  <style>
    /* Global scrollbar hiding for all elements */
    * {
      scrollbar-width: none !important; /* Firefox */
      -ms-overflow-style: none !important; /* Internet Explorer 10+ */
    }
    
    *::-webkit-scrollbar {
      display: none !important; /* WebKit */
    }
    
    /* Ensure iframes don't show scrollbars */
    iframe {
      scrollbar-width: none !important;
      -ms-overflow-style: none !important;
    }
    
    iframe::-webkit-scrollbar {
      display: none !important;
    }
  </style>
</head>
<body class="admin-body">

  <!-- Admin Header -->
  <header class="admin-header">
    <div class="header-left">
      <h1>
        <span class="brand-logo" aria-hidden="true"><img src="BC_House.png" alt="BarangayConnect logo" /></span>
        BarangayConnect
      </h1>
    </div>
    <div class="header-right">
      <div class="settings-dropdown">
        <button class="header-btn" title="Settings" onclick="toggleSettings()"><i class="fas fa-cog"></i></button>
        <div class="settings-menu" id="settingsMenu">
          <a href="#" class="settings-item" onclick="openUpdateProfile()">
            <i class="fas fa-user-edit"></i>
            <span>Update Profile</span>
          </a>
          <a href="#" class="settings-item" onclick="logout()">
            <i class="fas fa-sign-out-alt"></i>
            <span>Log out</span>
          </a>
        </div>
      </div>
    </div>
  </header>

  <!-- Admin Container -->
  <div class="admin-container">
    <!-- Modern Sidebar -->
    <aside class="modern-sidebar" aria-label="Primary">
      <div class="sidebar-toggle" onclick="toggleSidebar()">
        <div class="hamburger">
          <span></span>
          <span></span>
          <span></span>
        </div>
      </div>
      
      <div class="sidebar-content">
      <div class="sidebar-header">
        <div class="user-info">
            <div class="user-details">
              <h3 id="user-greeting">Hello, Resident!</h3>
              <p id="user-id-line">ID: —</p>
              <p>Community Member</p>
            </div>
          </div>
        </div>
        
        <nav class="sidebar-nav">
          <ul class="nav-list">
            <li class="nav-item active">
              <a href="#" class="nav-link" data-section="dashboard">
                <i class="fas fa-home"></i>
                <span>Home</span>
              </a>
            </li>
            <li class="nav-item">
              <a href="#" class="nav-link" data-section="reports">
                <i class="fas fa-file-invoice"></i>
                <span>Reports</span>
              </a>
            </li>
            <li class="nav-item">
              <a href="#" class="nav-link" data-section="requests">
                <i class="fas fa-file-alt"></i>
                <span>Requests</span>
              </a>
            </li>
            <li class="nav-item">
              <a href="#" class="nav-link" data-section="transparency">
                <i class="fas fa-balance-scale"></i>
                <span>Transparency</span>
              </a>
            </li>
            <li class="nav-item">
              <a href="#" class="nav-link" data-section="announcements">
                <i class="fas fa-bullhorn"></i>
                <span>Announcements</span>
              </a>
            </li>
            <li class="nav-item">
              <a href="#" class="nav-link" data-section="emergency">
                <i class="fas fa-phone"></i>
                <span>Emergency</span>
              </a>
            </li>
          </ul>
        </nav>
        
      </div>
    </aside>

    <!-- Main Content Area -->
    <main class="admin-main">
      <div class="main-content">
        <!-- Content sections will be loaded dynamically -->
        <div id="dashboard-section" class="content-section active">
          <iframe src="R_Home-Dashboard.html" frameborder="0" width="100%" height="100%" style="border: none; height: 100vh; margin: 0; padding: 0; display: block; overflow: hidden;"></iframe>
        </div>

        <div id="announcements-section" class="content-section">
          <iframe src="R_Announcements.html" frameborder="0" width="100%" height="100%" style="border: none; height: 100vh; margin: 0; padding: 0; display: block; overflow: hidden;"></iframe>
        </div>

        <div id="emergency-section" class="content-section">
          <iframe src="R_Emergency.html" frameborder="0" width="100%" height="100%" style="border: none; height: 100vh; margin: 0; padding: 0; display: block; overflow: hidden;"></iframe>
        </div>

        <div id="reports-section" class="content-section">
          <iframe src="R_Reports.html" frameborder="0" width="100%" height="100%" style="border: none; height: 100vh; margin: 0; padding: 0; display: block; overflow: hidden;"></iframe>
        </div>

        <div id="requests-section" class="content-section">
          <iframe src="R_Requests.html" frameborder="0" width="100%" height="100%" style="border: none; height: 100vh; margin: 0; padding: 0; display: block; overflow: hidden;"></iframe>
        </div>

        <div id="transparency-section" class="content-section">
          <iframe src="R_Transparency.html" frameborder="0" width="100%" height="100%" style="border: none; height: 100vh; margin: 0; padding: 0; display: block; overflow: hidden;"></iframe>
        </div>
      </div>
    </main>
  </div>

  <!-- Update Profile Modal -->
  <div id="updateProfileModal" class="modal">
    <div class="modal-content profile-modal">
      <span class="close" data-close="updateProfileModal">&times;</span>
      <h2><i class="fas fa-user-edit"></i> Update Profile</h2>
      
      <form id="updateProfileForm">
        <!-- Personal Information -->
        <div class="form-section">
          <h3><i class="fas fa-user"></i> Personal Information</h3>
          
          <div class="form-row">
            <div class="form-group">
              <label><i class="fas fa-user"></i> First Name</label>
              <input type="text" id="firstName" name="firstName" placeholder="Enter your first name" required>
            </div>
            <div class="form-group">
              <label><i class="fas fa-user"></i> Last Name</label>
              <input type="text" id="lastName" name="lastName" placeholder="Enter your last name" required>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label><i class="fas fa-envelope"></i> Email Address</label>
              <input type="email" id="email" name="email" placeholder="Enter your email address" required>
            </div>
            <div class="form-group">
              <label><i class="fas fa-phone"></i> Mobile Number</label>
              <input type="tel" id="mobile" name="mobile" placeholder="Enter your mobile number" required>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label><i class="fas fa-calendar"></i> Date of Birth</label>
              <input type="date" id="dateOfBirth" name="dateOfBirth" required>
            </div>
            <div class="form-group">
              <label><i class="fas fa-venus-mars"></i> Gender</label>
              <select id="gender" name="gender" required>
                <option value="">Select Gender</option>
                <option value="male">Male</option>
                <option value="female">Female</option>
                <option value="other">Other</option>
              </select>
            </div>
          </div>
        </div>

        <!-- Address Information -->
        <div class="form-section">
          <h3><i class="fas fa-map-marker-alt"></i> Address Information</h3>
          
          <div class="form-group">
            <label><i class="fas fa-home"></i> House Number & Street</label>
            <input type="text" id="street" name="street" placeholder="Enter house number and street" required>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label><i class="fas fa-building"></i> Barangay</label>
              <input type="text" id="barangay" name="barangay" value="Tambo" readonly>
            </div>
            <div class="form-group">
              <label><i class="fas fa-city"></i> City</label>
              <input type="text" id="city" name="city" value="Parañaque City" readonly>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label><i class="fas fa-map"></i> Postal Code</label>
              <input type="text" id="postalCode" name="postalCode" placeholder="Enter postal code" required>
            </div>
            <div class="form-group">
              <label><i class="fas fa-flag"></i> Province</label>
              <input type="text" id="province" name="province" value="Metro Manila" readonly>
            </div>
          </div>
        </div>

        <!-- Emergency Contact -->
        <div class="form-section">
          <h3><i class="fas fa-phone-alt"></i> Emergency Contact</h3>
          
          <div class="form-row">
            <div class="form-group">
              <label><i class="fas fa-user-friends"></i> Emergency Contact Name</label>
              <input type="text" id="emergencyName" name="emergencyName" placeholder="Enter emergency contact name" required>
            </div>
            <div class="form-group">
              <label><i class="fas fa-phone"></i> Emergency Contact Number</label>
              <input type="tel" id="emergencyNumber" name="emergencyNumber" placeholder="Enter emergency contact number" required>
            </div>
          </div>

          <div class="form-group">
            <label><i class="fas fa-link"></i> Relationship</label>
            <select id="emergencyRelationship" name="emergencyRelationship" required>
              <option value="">Select Relationship</option>
              <option value="spouse">Spouse</option>
              <option value="parent">Parent</option>
              <option value="sibling">Sibling</option>
              <option value="child">Child</option>
              <option value="friend">Friend</option>
              <option value="other">Other</option>
            </select>
          </div>
        </div>

        <!-- Form Actions -->
        <div class="form-actions">
          <button type="button" class="cancel-btn" onclick="closeUpdateProfile()">Cancel</button>
          <button type="submit" class="save-btn">
            <i class="fas fa-save"></i> Save Changes
          </button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // Navigation functionality
    document.querySelectorAll('.nav-link').forEach(link => {
      link.addEventListener('click', function(e) {
        e.preventDefault();
        
        // Remove active class from all nav items
        document.querySelectorAll('.nav-item').forEach(item => {
          item.classList.remove('active');
        });
        
        // Add active class to clicked item
        this.parentElement.classList.add('active');
        
        // Hide all content sections
        document.querySelectorAll('.content-section').forEach(section => {
          section.classList.remove('active');
        });
        
        // Show selected section
        const sectionId = this.getAttribute('data-section') + '-section';
        const targetSection = document.getElementById(sectionId);
        if (targetSection) {
          targetSection.classList.add('active');
        }
      });
    });

    // Settings dropdown functionality
    function toggleSettings() {
      const settingsMenu = document.getElementById('settingsMenu');
      settingsMenu.classList.toggle('show');
    }

    // Close settings menu when clicking outside
    document.addEventListener('click', function(event) {
      const settingsDropdown = document.querySelector('.settings-dropdown');
      const settingsMenu = document.getElementById('settingsMenu');
      
      if (!settingsDropdown.contains(event.target)) {
        settingsMenu.classList.remove('show');
      }
    });

    // Update Profile functionality
    function openUpdateProfile() {
      console.log('Opening Update Profile modal...');
      document.getElementById('settingsMenu').classList.remove('show');
      const modal = document.getElementById('updateProfileModal');
      if (modal) {
        modal.style.display = 'block';
        console.log('Modal should be visible now');
        
        // Pre-fill form with current user data
        populateUserData();
      } else {
        console.error('Modal element not found!');
      }
    }

    // Function to populate form with current user data
    function populateUserData() {
      // Get current user from localStorage (from login system)
      const users = JSON.parse(localStorage.getItem('users')) || [];
      const currentUser = users.find(user => user.isLoggedIn) || users[users.length - 1]; // Get last logged in user or most recent user
      
      if (currentUser) {
        // Pre-fill personal information
        document.getElementById('firstName').value = currentUser.firstName || (currentUser.name ? currentUser.name.split(' ')[0] : '');
        document.getElementById('lastName').value = currentUser.lastName || (currentUser.name ? currentUser.name.split(' ').slice(1).join(' ') : '');
        document.getElementById('email').value = currentUser.email || '';
        document.getElementById('mobile').value = currentUser.mobile || '';
        
        // If user has additional profile data stored, populate those too
        if (currentUser.profileData) {
          document.getElementById('dateOfBirth').value = currentUser.profileData.dateOfBirth || '';
          document.getElementById('gender').value = currentUser.profileData.gender || '';
          document.getElementById('street').value = currentUser.profileData.street || '';
          document.getElementById('postalCode').value = currentUser.profileData.postalCode || '';
          document.getElementById('emergencyName').value = currentUser.profileData.emergencyName || '';
          document.getElementById('emergencyNumber').value = currentUser.profileData.emergencyNumber || '';
          document.getElementById('emergencyRelationship').value = currentUser.profileData.emergencyRelationship || '';
        }
        
        console.log('Form populated with user data:', currentUser);
      } else {
        console.log('No user data found to pre-fill');
      }
    }

    // Logout functionality
    function logout() {
      if (confirm('Are you sure you want to logout?')) {
        alert('You have been logged out.');
        window.location.href = '../Front.html';
      }
      document.getElementById('settingsMenu').classList.remove('show');
    }

    // Modern sidebar toggle
    function toggleSidebar() {
      document.querySelector('.modern-sidebar').classList.toggle('collapsed');
    }
    
    // Add click event to hamburger menu icon
    document.addEventListener('DOMContentLoaded', function() {
      const hamburgerIcon = document.querySelector('.sidebar-toprow i.fa-bars');
      if (hamburgerIcon) {
        hamburgerIcon.addEventListener('click', toggleSidebar);
        hamburgerIcon.style.cursor = 'pointer';
      }
    });

    // Compute header height and update CSS variable so sidebar/content align with no gap
    function setHeaderOffset() {
      var header = document.querySelector('.admin-header');
      if (!header) return;
      var borderBottom = 3; // matches CSS border-bottom thickness
      var offset = header.offsetHeight + borderBottom;
      document.documentElement.style.setProperty('--header-offset', offset + 'px');
    }

    // Set greeting with user's first name
    function setUserGreeting() {
      const greetingElement = document.getElementById('user-greeting');
      const idElement = document.getElementById('user-id-line');
      if (greetingElement) {
        const users = JSON.parse(localStorage.getItem('users')) || [];
        const currentUserIndex = users.findIndex(user => user.isLoggedIn);
        const currentUser = currentUserIndex !== -1 ? users[currentUserIndex] : undefined;

        if (currentUser && currentUser.name) {
          // Always use the first word of the name
          const firstName = currentUser.name.split(' ')[0];
          greetingElement.textContent = `Hello, ${firstName}!`;
          // Ensure resident ID exists; generate if missing - use highest existing ID + 1
          if (!currentUser.residentId) {
            const adminUsers = JSON.parse(localStorage.getItem('adminUsers')) || [];
            const pendingRegistrations = JSON.parse(localStorage.getItem('pendingRegistrations')) || [];
            const allIds = [
              ...users.map(u => u.residentId || u.id).filter(Boolean),
              ...adminUsers.map(u => u.residentId || u.id).filter(Boolean),
              ...pendingRegistrations.map(p => p.residentId).filter(Boolean)
            ];
            
            const getMaxId = () => {
              if (allIds.length === 0) return 0;
              const numbers = allIds
                .map(id => {
                  const match = id.toString().match(/RES(\d+)/i);
                  return match ? parseInt(match[1], 10) : 0;
                })
                .filter(n => n > 0);
              return numbers.length > 0 ? Math.max(...numbers) : 0;
            };
            
            const nextIdNum = getMaxId() + 1;
            currentUser.residentId = `RES${nextIdNum.toString().padStart(3, '0')}`;
            users[currentUserIndex] = currentUser;
            localStorage.setItem('users', JSON.stringify(users));
          }
          if (idElement) idElement.textContent = `ID: ${currentUser.residentId}`;
        } else {
          greetingElement.textContent = 'Hello, Resident!'; // Fallback
          if (idElement) idElement.textContent = 'ID: —';
        }
      }
    }
    function setCurrentDate() {
      var dateElement = document.getElementById('current-date');
      if (dateElement) {
        var today = new Date();
        var options = { 
          weekday: 'long', 
          year: 'numeric', 
          month: 'long', 
          day: 'numeric' 
        };
        dateElement.textContent = today.toLocaleDateString('en-US', options);
      }
    }
    
    window.addEventListener('load', function() {
      setHeaderOffset();
      setCurrentDate();
      setUserGreeting();
      // Heartbeat: record current user's last active time on load
      recordResidentHeartbeat();
    });
    window.addEventListener('resize', setHeaderOffset);

    // Persist the current user's last active timestamp
    function recordResidentHeartbeat() {
      const users = JSON.parse(localStorage.getItem('users')) || [];
      const idx = users.findIndex(u => u.isLoggedIn) ?? -1;
      if (idx !== -1 && users[idx]) {
        users[idx].profileData = users[idx].profileData || {};
        users[idx].profileData.lastActiveISO = new Date().toISOString();
        localStorage.setItem('users', JSON.stringify(users));
      }
    }

    // Update last active when tab becomes visible/focused
    document.addEventListener('visibilitychange', function() {
      if (!document.hidden) recordResidentHeartbeat();
    });
    window.addEventListener('focus', recordResidentHeartbeat);
    // Periodic heartbeat every minute while the page is open
    setInterval(recordResidentHeartbeat, 60 * 1000);

    // Close Update Profile Modal
    function closeUpdateProfile() {
      document.getElementById('updateProfileModal').style.display = 'none';
    }

    // Handle Update Profile Form Submission
    document.getElementById('updateProfileForm').addEventListener('submit', function(e) {
      e.preventDefault();
      
      // Get form data
      const formData = new FormData(this);
      
      // Validate required fields
      const requiredFields = ['firstName', 'lastName', 'email', 'mobile', 'dateOfBirth', 'gender', 'street', 'postalCode', 'emergencyName', 'emergencyNumber', 'emergencyRelationship'];
      let isValid = true;
      
      requiredFields.forEach(field => {
        const input = document.getElementById(field);
        if (!input.value.trim()) {
          input.style.borderColor = '#e74c3c';
          isValid = false;
        } else {
          input.style.borderColor = '#e0e0e0';
        }
      });

      if (!isValid) {
        alert('Please fill in all required fields.');
        return;
      }

      // Save updated profile data to localStorage
      const users = JSON.parse(localStorage.getItem('users')) || [];
      const currentUserIndex = users.findIndex(user => user.isLoggedIn) || users.length - 1;
      
      if (users[currentUserIndex]) {
        // Update basic user info
        const firstName = document.getElementById('firstName').value;
        const lastName = document.getElementById('lastName').value;
        users[currentUserIndex].firstName = firstName;
        users[currentUserIndex].lastName = lastName;
        users[currentUserIndex].name = `${firstName} ${lastName}`;
        users[currentUserIndex].email = document.getElementById('email').value;
        users[currentUserIndex].mobile = document.getElementById('mobile').value;
        
        // Save additional profile data
        users[currentUserIndex].profileData = {
          dateOfBirth: document.getElementById('dateOfBirth').value,
          gender: document.getElementById('gender').value,
          street: document.getElementById('street').value,
          postalCode: document.getElementById('postalCode').value,
          emergencyName: document.getElementById('emergencyName').value,
          emergencyNumber: document.getElementById('emergencyNumber').value,
          emergencyRelationship: document.getElementById('emergencyRelationship').value,
          lastUpdated: new Date().toISOString()
        };
        
      // Save back to localStorage
      localStorage.setItem('users', JSON.stringify(users));

      // Also record this submission as a pending registration for Admin pages
      const pendingRegistrations = JSON.parse(localStorage.getItem('pendingRegistrations')) || [];
      // Ensure the current user has a residentId - use highest existing ID + 1
      if (!users[currentUserIndex].residentId) {
        const adminUsers = JSON.parse(localStorage.getItem('adminUsers')) || [];
        const allIds = [
          ...users.map(u => u.residentId || u.id).filter(Boolean),
          ...adminUsers.map(u => u.residentId || u.id).filter(Boolean),
          ...pendingRegistrations.map(p => p.residentId).filter(Boolean)
        ];
        
        const getMaxId = () => {
          if (allIds.length === 0) return 0;
          const numbers = allIds
            .map(id => {
              const match = id.toString().match(/RES(\d+)/i);
              return match ? parseInt(match[1], 10) : 0;
            })
            .filter(n => n > 0);
          return numbers.length > 0 ? Math.max(...numbers) : 0;
        };
        
        const nextIdNum = getMaxId() + 1;
        const nextId = `RES${nextIdNum.toString().padStart(3, '0')}`;
        users[currentUserIndex].residentId = nextId;
        localStorage.setItem('users', JSON.stringify(users));
      }
      const pendingEntry = {
        residentId: users[currentUserIndex].residentId,
        firstName,
        lastName,
        email: document.getElementById('email').value,
        mobile: document.getElementById('mobile').value,
        status: 'PENDING',
      };
      pendingRegistrations.push(pendingEntry);
      localStorage.setItem('pendingRegistrations', JSON.stringify(pendingRegistrations));
      // Update shared pending count for admin dashboards
      localStorage.setItem('pendingRegistrationsCount', pendingRegistrations.length.toString());
        
        alert('Profile updated successfully!');
        closeUpdateProfile();
        
        // Update the greeting with new first name
        setUserGreeting();
        
        // Reset form
        this.reset();
      } else {
        alert('Error: User not found. Please try logging in again.');
      }
    });

    // Close modal when clicking outside
    document.getElementById('updateProfileModal').addEventListener('click', function(e) {
      if (e.target === this) {
        closeUpdateProfile();
      }
    });

    // Close modal with close button
    document.querySelector('[data-close="updateProfileModal"]').addEventListener('click', function() {
      closeUpdateProfile();
    });
  </script>
</body>
</html>
